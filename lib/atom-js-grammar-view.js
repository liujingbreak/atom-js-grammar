// Generated by CoffeeScript 1.10.0
var $ = require('./jquery-1.12.0.js');
var Emitter = require('eventemitter3');
var _ = require('lodash');
var AtomJsGrammarView;

module.exports = AtomJsGrammarView = (function() {
	function AtomJsGrammarView(serializedState) {
		Emitter.call(this);
		var self = this;
		self.state = serializedState;
		$ = $ ? $ : window.$;

		this.element = document.createElement('div');
		this.element.classList.add('atom-js-grammar');

		var el = $(this.element);
		self.el = el;
		el.attr('tabIndex', '1');
		el.on('keydown', function(evt) {
			if (evt.keyCode === 27 || evt.keyCode === 13 ) { //press ESC
				self.emit('close');
			}
		});
		el.delegate('.list-item', 'click', function(evt) {
			atom.workspace.observeTextEditors(function(editor) {
				var loc = $(evt.currentTarget).attr('data-loc');
				console.log(loc);
				loc = self.locData[loc];
				editor.setCursorBufferPosition([loc.start.line - 1, loc.start.column]);
				self.emit('close');
			});
		});
		$('body').on('click', function(evt) {
			if (!_.some($(evt.target).parents(), function(dom) {
				return (dom === self.element);
			})) {
				self.emit('close');
			}
		});

		this.title = $('<div>');
		this.title.html('The AtomJsGrammar package is Alive! It\'s ALIVE!');
		this.title.addClass('title');
		el.append(this.title);

		this.body = $('<ul>');
		this.body.attr('tabIndex', '0');
		el.append(this.body);
		this.body.addClass('body list-tree has-collapsable-children');
	}
	AtomJsGrammarView.prototype = Object.create(Emitter.prototype);

	var prot = AtomJsGrammarView.prototype;

	prot.serialize = function() {};

	prot.destroy = function() {
		return this.element.remove();
	};
	prot.getElement = function() {
		return this.element;
	};
	prot.focus = function() {
		this.el.focus();
	};

	prot.render = function render() {
		this.title.html(this.state.fileName);
		var tree = this.state.tree;
		this.body.html('');
		this.locData = [];
		this.view4Node(tree.child, this.body);
	};

	prot.view4Node = function(nodes, container) {
		var self = this;
		nodes.forEach(function(node) {
			var nestedItem = $('<li>');
			if (node.child && node.child.length > 0) {
				nestedItem.addClass('list-nested-item');
				var label = $('<div>');

				label.attr('data-loc', self.locData.length);
				self.locData.push(node.loc);

				label.addClass('list-item');
				label.html(node.name ? node.name : '()');
				nestedItem.append(label);
				container.append(nestedItem);

				var subContainer = $('<ul>');
				subContainer.addClass('list-tree');
				nestedItem.append(subContainer);

				self.view4Node(node.child, subContainer);
			} else {
				nestedItem.attr('data-loc', self.locData.length);
				self.locData.push(node.loc);

				nestedItem.addClass('list-item');
				nestedItem.html(node.name ? node.name : '()');
				container.append(nestedItem);
			}
		});
	};

	return AtomJsGrammarView;
})();
